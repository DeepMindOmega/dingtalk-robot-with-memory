# 钉钉机器人 + 记忆系统集成使用指南

## 功能概述

钉钉机器人现在集成了智能记忆系统，实现了以下核心功能：

### 1. 智能上下文增强
当用户提问复杂问题时，机器人会：
1. 自动判断问题是否需要参考经验
2. 搜索记忆系统中的相关经验
3. 将相关经验自动添加到OpenCode上下文中
4. AI基于这些历史经验提供更准确的答案

**触发条件**：
- 消息包含："如何"、"解决"、"错误"、"经验"、"配置"、"部署"、"调试"等关键词
- 消息长度超过20个字符
- 不是简单问候或计算类问题

**效果**：
- 减少重复解释相同问题
- 基于历史经验快速定位问题
- 提供更精准的解决方案

### 2. 自动学习机制
每次对话结束后，机器人会：
1. 分析对话内容
2. 识别成功案例和失败教训
3. 自动提取关键经验
4. 保存到记忆系统

**提取类型**：
- **success_case**：成功解决的问题
- **failure_lesson**：遇到的错误和失败经验
- **skill_growth**：新掌握的技能和知识

### 3. 记忆查询命令
用户可以通过以下命令查询记忆系统：

- `记忆查询 [关键词]` - 搜索相关记忆
- `记忆统计` - 查看记忆统计
- `记忆状态` - 查看记忆系统状态

### 4. 分类管理
所有记忆按以下分类存储：
- **success_case**: 成功案例
- **failure_lesson**: 失败教训
- **skill_growth**: 技能成长
- **user_preference**: 用户偏好
- **context**: 上下文记忆
- **short_term**: 短期记忆

### 5. 使用示例

**智能检索示例**：
```
用户: 如何使用Token缓存机制？

机器人: [自动检索记忆系统]
[找到3条相关记忆...]
[自动添加到OpenCode上下文...]
基于经验，Token缓存可以有效减少API调用次数...
```

**手动查询示例**：
```
用户: 记忆查询 Token
机器人: 找到5条相关记忆：
1. Token自动缓存机制实现...
2. Token缓存5分钟提前刷新避免过期...
...
3. ...
```

**记忆统计示例**：
```
用户: 记忆统计
机器人: 记忆系统统计：
- 总记忆数: 254
- 长期记忆: 116
- 成功案例: 93
- 短期记忆: 20
- 上下文: 20
```

## 技术架构

```
钉钉机器人
    ↓
processor.py
    ↓ (集成记忆系统)
memory_integration.py
    ↓ (集成记忆系统)
memory_client.py
    ↓
    ↓
记忆系统API (FastAPI)
    ↓
数据库 (SQLite)
```

## 文件结构

```
~/.opencode/skills/dingtalk-robot/
├── src/
│   ├── processor.py          # 主处理器（已修改）
│   ├── memory_client.py     # 记忆客户端（新）
│   └── memory_integration.py # 记忆集成器（新）
└── sessions.json            # 会话管理
```

```

~/intelligent-memory-system/
├── src/
│   ├── api/
│   │   ├── main.py        # API服务器
│   │   └── routers/
│   │       ├── memory.py      # 记忆API路由
│   │       └── ...
│   └── storage/
│       ├── db_init.py       # 数据库初始化
│       └── memory_manager.py  # 记忆管理
└── data/
    └── memory_system.db   # SQLite数据库
```

## 启动服务

1. 确保记忆系统API服务器运行：
```bash
cd ~/intelligent-memory-system
python3 -m uvicorn src.api.main:app --host 0.0.0.0 --port 8000
```

2. 钉钉机器人会自动连接记忆系统

## 注意事项

- 记忆系统API服务器目前可能偶尔超时，建议定期重启优化
- 记忆内容会自动积累，建议定期清理过期记忆
- 检索关键词需要准确，否则会返回无关记忆
- 简单问候不会被记录到记忆系统（节省存储空间）

## 未来优化方向

1. 实现语义搜索（embedding + 向量数据库）
2. 优化API响应速度
3. 添加记忆相似度评分和去重
4. 实现记忆推荐系统
5. 添加记忆导出/导入功能
