# OpenCode 操作控制经验

**Type**: long_term
**Source**: opencode_experience
**Created**: 2026-02-14T23:33:37.137352+00:00
**ID**: 96

**Tags**: opencode, config, security

---

## 概述
文档时间范围：2026-01-30 至 2026-02-15
系统：OpenCode (Oh-My-OpenCode)
核心任务：OpenCode系统配置、模型优化、记忆系统研究

### 成功1：模型配置优化 - 多套餐合理分配
**成功步骤**
1. 分析三个Coding套餐的特点和优势
2. 根据智能体特性分配最优模型
3. 配置provider和baseURL
4. 验证各智能体使用正确的模型
5. 达到成本最优和性能平衡

**关键配置**
```json
{
  "providers": {
    "zhipuai-coding-plan": {
      "options": {
        "baseURL": "https://open.bigmodel.cn/api/coding/paas/v4",
        "apiKey": "your_api_key_here"
      }
    },
    "dashscope": {
      "options": {
        "baseURL": "https://coding.dashscope.aliyuncs.com/v1",
        "apiKey": "your_api_key_here"
      }
    },
    "anthropic": {
      "options": {
        "baseURL": "https://ai-in.one/v1",
        "apiKey": "your_api_key_here"
      }
    }
  }
}
```

**模型分配策略**

| 智能体/分类 | 模型 | 来源 | 理由 |
|---------------|------|------|
| **sisyphus** (主Agent) | glm-5 | 智谱max | 主智能体需要最强模型 |
| **oracle** (顾问) | glm-5 | 智谱max | 架构决策需要强推理 |
| **librarian** (文档搜索) | qwen3-coder-plus | 百炼轻量，文档搜索够用 |
| **explore** (代码探索) | qwen3-coder-plus | 百炼轻量，代码探索够用 |
| **multimodal-looker** (视觉) | glm-4.6v | 智谱max，只有智谱有视觉模型 |
| **prometheus** (规划) | qwen3-max | 百炼旗舰，规划需要强推理 |
| **metis** (需求分析) | qwen3-max | 百炼旗舰，需求分析需要强推理 |
| **momus** (代码审查) | claude-3-5-sonnet | 偶尔审查，偶尔Claude质量更高 |
| **visual-engineering** | qwen3-coder-plus | 百炼代码，前端开发用百炼 |
| **ultrabrain** | qwen3-max | 百炼旗舰，困难任务 |
| **writing** | glm-5 | 智谱max，写作用智谱 |

**核心原则**
- 主要用智谱和百炼，尽量少用Claude（成本控制）
- 智谱max用于主Agent、顾问、写作（最强推理）
- 百炼轻量用于探索、开发任务（成本优化）
- 百炼旗舰用于规划、需求分析（平衡性能和成本）

---

### 成功2：记忆系统研究 - opencode-mem 安全审计通过
**成功步骤**
1. 对比多个OpenCode记忆插件（stars、特点、适用场景）
2. 深入分析opencode-mem的安全性和隐私性
3. 验证opencode-mem的可复用度（约70%兼容claude-mem）
4. 进行安全审计（本地运行、无遥测、无追踪）
5. 推荐最佳配置方案

**OpenCode生态记忆插件对比**

| 插件 | Stars | 特点 | 适用场景 |
|------|-------|------|----------|
| **opencode-supermemory** | ⭐ 635 | 云端存储，跨项目同步 | 多设备协作 |
| **opencode-mem** | ⭐ 84 | 本地向量数据库，隐私优先 | 单人隐私场景 |
| **opencode-agent-memory** | ⭐ 38 | 可编辑记忆块，Markdown存储 | 频繁编辑 |
| **opencode-plugin-simple-memory** | - | 轻量级持久记忆 | 简单需求 |
| **claude-mem-opencode** | ⭐ 2 | claude-mem的OpenCode集成版 | Claude Code专用 |

**opencode-mem 安全审计结果**

| 评估项 | 结果 | 详情 |
|--------|------|------|
| **本地运行** | ✅ 完全本地，默认无网络请求 | 检查无遥测/追踪 |
| **数据存储** | ✅ 全部在 `~/.opencode-mem/` | 检查无上传 |
| **遥测/追踪** | ✅ 无任何遥测或分析 | 检查无追踪 |
| **Web Server** | ✅ 仅本地访问（127.0.0.1:4747） | 检查仅本机访问 |
| **Embedding** | ✅ 本地模型（`@xenova/transformers`） | 检查本地模型 |
| **依赖数量** | ✅ 精简（仅5个生产依赖） | 检查依赖：5个生产依赖 |
| **依赖漏洞** | ✅ 0 个已知漏洞 | 检查无已知漏洞 |

**推荐配置**
```jsonc
{
  "embeddingModel": "Xenova/nomic-embed-text-v1",
  "webServerHost": "127.0.0.1",
  "webServerPort": 4747,
  "autoCaptureEnabled": false
}
```

**核心优势**
- 完全本地，无需外部服务
- 已有成熟的OpenCode集成
- 6天前刚更新（v2.7.3），活跃维护
- 84 stars是本地方案中最高的
- 安全可靠，通过安全审计

---

### 成功3：agent-browser 工具验证
**成功步骤**
1. 全局安装agent-browser工具
2. 配置使用系统Chrome，避免下载Chromium失败
3. 测试核心命令功能
4. 验证Snapshot + Refs工作流

**测试命令**
```bash
# 导航到URL
open https://example.com

# 获取交互元素及引用
snapshot -i

# 点击元素引用
click @e1

# 获取页面信息
get url/title

# 捕获页面
screenshot

# 浏览器导航
back

# 结束会话
close
```

**核心优势**
- Snapshot + Refs工作流，减少93% context使用
- 使用系统Chrome，无需下载浏览器
- 支持元素引用，精确交互

---

### 💡 重要技能和知识


### OpenCode模型配置能力
**配置文件位置**
- 主配置：`~/.config/opencode/oh-my-opencode.json`
- 技能配置：`~/.opencode/skills/*/config.json`

**Provider配置**
```json
{
  "provider": {
    "zhipuai-coding-plan": {
      "options": {
        "baseURL": "https://open.bigmodel.cn/api/coding/paas/v4",
        "apiKey": "your_key"
      }
    },
    "dashscope": {
      "options": {
        "baseURL": "https://coding.dashscope.aliyuncs.com/v1",
        "apiKey": "your_key"
      }
    }
  }
}
```

**智能体配置**
```json
{
  "sisphus": {
    "model": "zhipuai-coding-plan/glm-5"
  },
  "oracle": {
    "model": "zhipuai-coding-plan/glm-5"
  },
  "categories": {
    "visual-engineering": {
      "model": "dashscope/qwen3-coder-plus"
    },
    "ultrabrain": {
      "model": "dashscope/qwen3-max"
    },
    "writing": {
      "model": "zhipuai-coding-plan/glm-5"
    }
  }
}
```

### OpenCode会话管理
**会话列表查看**
```bash
opencode sessions_list
```

**会话历史查看**
```bash
opencode sessions_history
```

**发送消息到会话**
```bash
opencode sessions_send --id <session_id> "your message"
```

**生成新会话**
```bash
opencode sessions_spawn --prompt "your task"
```

**会话状态查看**
```bash
opencode session_status --id <session_id>
```

### OpenCode记忆系统
**记忆搜索**
```bash
opencode memory_search "your query"
```

**获取记忆**
```bash
opencode memory_get --id <memory_id>
```

---

### 📊 关键决策


### 模型选择策略
1. **性能优先** → 智谱max (glm-5)
   - 主Agent、顾问、写作
   - 架构决策、强推理任务

2. **成本优化** → 百炼轻量 (qwen3-coder-plus)
   - 探索、代码开发、文档搜索
   - 轻量任务、快速迭代

3. **平衡选择** → 百炼旗舰 (qwen3-max)
   - 规划、需求分析、困难任务
   - 平衡性能和成本

### 记忆系统选择
**推荐方案**：Fork opencode-mem + claude-mem的增强功能

**理由**：
1. opencode-mem已实现80%的claude-mem功能
2. 完全本地，无需外部服务
3. 已有成熟的OpenCode集成
4. 84 stars是本地方案中最高的
5. 活跃维护（6天前刚更新v2.7.3）

**需要从claude-mem借鉴的功能**：
- 3-Layer搜索工作流（10x token节省）
- 结构化观察/摘要（更丰富的schema）
- 细粒度向量存储（字段级）
- 会话时间线（上下文连续性）

---

### 🔴 经验教训


### 教训1：进程管理问题
**问题描述**
- 运行了2个OpenCode实例
- 一个在后台运行（PID 341319），另一个在当前终端
- 可能导致资源浪费或冲突

**教训**
- 定期检查进程状态：`ps aux | grep opencode`
- 避免重复启动实例
- 使用命令前检查是否已有运行实例

### 教训2：技能安装需谨慎
**安全偏好**
- 偏好纯文档技能（无可执行代码）
- 强调在安装前验证技能安全性
- 重点关注维护系统完整性
- 强烈的安全优先思维

**拒绝的技能类型**
- 包含可执行脚本的技能（.sh, .py, .js）
- 需要外部工具安装的技能
- 包含二进制组件的技能
- 包含外部依赖的技能

---

### 🎯 最佳实践


### 1. 模型配置
1. **根据任务类型选择模型**
   - 主Agent、顾问、写作 → 智谱max
   - 代码探索、开发 → 百炼轻量
   - 规划、需求分析 → 百炼旗舰
   - 代码审查（偶尔） → Claude

2. **成本控制原则**
   - 主要用智谱和百炼
   - 尽量少用Claude（仅用于代码审查）
   - 定期评估模型使用情况

### 2. 记忆系统管理
1. **本地优先**
   - 优先使用本地存储方案
   - 避免云端数据泄露
   - 定期审计安全性

2. **功能完整性**
   - 选择功能完整的解决方案
   - 考虑社区活跃度（stars）
   - 查看更新频率

### 3. 会话管理
1. **定期清理**
   - 删除不需要的会话
   - 整理会话历史
   - 保持会话列表清晰

2. **会话命名**
   - 使用有意义的会话名称
   - 包含任务和日期信息
   - 便于后续查找

---

### 🔧 常用命令


### OpenCode管理
```bash
# 查看版本
opencode --version

# 查看配置
opencode config get

# 设置配置
opencode config set <key> <value>

# 查看已安装技能
opencode plugins list

# 安装技能
bunx opencode-mem install

# 卸载技能
bunx opencode-mem uninstall
```

### 会话操作
```bash
# 列出所有会话
opencode sessions_list

# 查看会话历史
opencode sessions_history --id <session_id>

# 发送消息
opencode sessions_send --id <session_id> "message"

# 创建新会话
opencode sessions_spawn --prompt "task description"
```

### 记忆操作
```bash
# 搜索记忆
opencode memory_search "query"

# 获取特定记忆
opencode memory_get --id <memory_id>

# 列出记忆
opencode memory_list
```

---

### 📚 参考文档


### 官方文档
- OpenCode文档：https://docs.oh-my-opencode.ai/
- opencode-mem：https://github.com/openclaw/opencode-mem

### 相关文档
- `/home/admin/clawdbot-experience-summary/05_安全经验.md`
- `/home/admin/clawdbot-experience-summary/06_项目开发经验.md`

---

*文档创建时间：2026-02-15*
*基于OpenCode会话总结整理完成*