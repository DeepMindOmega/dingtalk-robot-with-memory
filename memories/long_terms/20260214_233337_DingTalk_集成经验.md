# DingTalk é›†æˆç»éªŒ

**Type**: long_term
**Source**: opencode_experience
**Created**: 2026-02-14T23:33:37.126076+00:00
**ID**: 93

**Tags**: dingtalk, api, config

---

## æ¦‚è¿°
æ–‡æ¡£æ—¶é—´èŒƒå›´ï¼š2026-01-30 è‡³ 2026-02-13
ç³»ç»Ÿï¼šClawdbot AIåŠ©æ‰‹
é›†æˆç›®æ ‡ï¼šé€šè¿‡é’‰é’‰è‡ªå®šä¹‰æœºå™¨äººå‘é€æ¶ˆæ¯å’Œå›¾ç‰‡

### å¤±è´¥1ï¼šå›¾ç‰‡æ˜¾ç¤ºä¸ºæŸåå›¾æ ‡
**é—®é¢˜æè¿°**
- å›¾ç‰‡ä¸Šä¼ æˆåŠŸ
- æ¶ˆæ¯å‘é€æˆåŠŸ
- åœ¨é’‰é’‰ä¸­å›¾ç‰‡æ˜¾ç¤ºä¸ºæŸåçš„æ–‡ä»¶å›¾æ ‡ï¼Œè€Œä¸æ˜¯å®žé™…å›¾ç‰‡

**å¤±è´¥åŽŸå› **
1. **é”™è¯¯çš„APIç«¯ç‚¹**ï¼š
   - ä½¿ç”¨äº†æ–°ç‰ˆAPIç«¯ç‚¹ï¼š`https://api.dingtalk.com/v1.0/media/upload`
   - åº”è¯¥ä½¿ç”¨æ—§ç‰ˆç«¯ç‚¹ï¼š`https://oapi.dingtalk.com/media/upload`

2. **é”™è¯¯çš„æ¶ˆæ¯ç±»åž‹**ï¼š
   - ä½¿ç”¨äº†ï¼š`msgtype: "image"`
   - åº”è¯¥ä½¿ç”¨ï¼š`msgtype: "sampleImageMsg"`

3. **é”™è¯¯çš„å‚æ•°å­—æ®µ**ï¼š
   - ä½¿ç”¨äº†ï¼š`{"imageKey": media_id}`
   - åº”è¯¥ä½¿ç”¨ï¼š`{"photoURL": media_id}`

**é”™è¯¯æ—¥å¿—**
```
é”™è¯¯ä¿¡æ¯: gateway closed (1008): unauthorized
APIç«¯ç‚¹ä½¿ç”¨ä¸å½“
æ¶ˆæ¯æ ¼å¼ä¸åŒ¹é…é’‰é’‰è¦æ±‚
```

**è§£å†³æ–¹æ¡ˆ**
```javascript
// æ­£ç¡®çš„å›¾ç‰‡å‘é€æ–¹å¼
// 1. ä¸Šä¼ å›¾ç‰‡åˆ°é’‰é’‰æœåŠ¡å™¨ï¼ˆä½¿ç”¨æ—§ç‰ˆAPIï¼‰
const uploadUrl = `https://oapi.dingtalk.com/media/upload?access_token=${accessToken}&type=image`;
const formData = new FormData();
formData.append('media', fs.createReadStream(imagePath));

const uploadResponse = await axios.post(uploadUrl, formData, {
  headers: formData.getHeaders()
});

if (uploadResponse.data.errcode === 0) {
  const media_id = uploadResponse.data.media_id;
  
  // 2. å‘é€å›¾ç‰‡æ¶ˆæ¯ï¼ˆä½¿ç”¨æ­£ç¡®çš„ msgtype å’Œå‚æ•°ï¼‰
  const msg = {
    msgtype: "sampleImageMsg",  // å…³é”®ï¼šä½¿ç”¨ sampleImageMsg
    sampleImageMsg: {
      photoURL: media_id  // å…³é”®ï¼šä½¿ç”¨ photoURL è€Œéž imageKey
    }
  };
  
  await sendDingTalkMessage(webhookUrl, msg);
}
```

**å…³é”®è¦ç‚¹**
- âœ… å¿…é¡»ä½¿ç”¨æ—§ç‰ˆAPIç«¯ç‚¹ `oapi.dingtalk.com`
- âœ… æ¶ˆæ¯ç±»åž‹å¿…é¡»æ˜¯ `sampleImageMsg`
- âœ… å‚æ•°å­—æ®µå¿…é¡»æ˜¯ `photoURL`ï¼Œä¸èƒ½æ˜¯ `imageKey`
- âœ… å®˜æ–¹æ–‡æ¡£ä¸­çš„å‚æ•°åç§°å¿…é¡»å®Œå…¨åŒ¹é…

---

### å¤±è´¥2ï¼šç½‘å…³ä»¤ç‰Œä¸åŒ¹é…
**é—®é¢˜æè¿°**
- æµè§ˆå™¨åŠŸèƒ½æ— æ³•ä½¿ç”¨
- CLIå®¢æˆ·ç«¯è¿žæŽ¥è¢«æ‹’ç»
- é”™è¯¯ä¿¡æ¯ï¼š`gateway closed (1008): unauthorized: gateway token mismatch`

**å¤±è´¥åŽŸå› **
1. **ä»¤ç‰Œé…ç½®åˆ†æ•£åœ¨å¤šä¸ªä½ç½®**ï¼š
   - `gateway.auth.token` - è®¤è¯ä»¤ç‰Œ
   - `gateway.remote.token` - è¿œç¨‹ä»¤ç‰Œ
   - çŽ¯å¢ƒå˜é‡ `CLAWDBOT_GATEWAY_TOKEN`
   - è¿™äº›ä½ç½®é…ç½®ä¸ä¸€è‡´

2. **systemdæœåŠ¡æ–‡ä»¶ä¸­çš„ä»¤ç‰Œå€¼é”™è¯¯**ï¼š
   - systemdæœåŠ¡æ–‡ä»¶ä¸­è®¾ç½®çš„ä»¤ç‰Œå€¼ä¸Žé…ç½®æ–‡ä»¶ä¸­ä¸ä¸€è‡´
   - å¯¼è‡´CLIå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä½¿ç”¨ä¸åŒçš„ä»¤ç‰Œ

**é”™è¯¯æ—¥å¿—**
```
gateway closed (1008): unauthorized: gateway token mismatch
Gateway target: ws://127.0.0.1:18789
Config: /home/admin/.clawdbot/clawdbot.json
Bind: loopback
```

**è§£å†³æ–¹æ¡ˆ**
```bash
# 1. ç»Ÿä¸€ä»¤ç‰Œé…ç½®åˆ°æ‰€æœ‰ä½ç½®
# æ–¹æ¡ˆ1ï¼šè®¾ç½®çŽ¯å¢ƒå˜é‡
export CLAWDBOT_GATEWAY_TOKEN=your_correct_token

# æ–¹æ¡ˆ2ï¼šåœ¨é…ç½®æ–‡ä»¶ä¸­ç»Ÿä¸€ä»¤ç‰Œ
cat > ~/.clawdbot/clawdbot.json << 'EOF'
{
  "gateway": {
    "auth": {
      "mode": "token",
      "token": "your_correct_token"
    },
    "remote": {
      "token": "your_correct_token"
    }
  }
}
EOF

# 2. é‡å¯ç½‘å…³æœåŠ¡
clawdbot gateway stop
clawdbot gateway start

# 3. éªŒè¯è¿žæŽ¥
clawdbot gateway status
```

**å…³é”®è¦ç‚¹**
- âœ… ç¡®ä¿ä»¤ç‰Œåœ¨æ‰€æœ‰é…ç½®ä½ç½®ä¿æŒä¸€è‡´
- âœ… ä¿®æ”¹é…ç½®åŽå¿…é¡»é‡å¯æœåŠ¡
- âœ… ä½¿ç”¨ `systemctl --user` å‘½ä»¤ç®¡ç†æœåŠ¡ï¼Œä¸è¦ä½¿ç”¨ `pkill`

---

### æˆåŠŸ1ï¼šDingTalkå›¾ç‰‡å‘é€ä¿®å¤
**æˆåŠŸæ­¥éª¤**
1. è¯†åˆ«APIç«¯ç‚¹é”™è¯¯ï¼šä»Ž `api.dingtalk.com/v1.0/media/upload` æ”¹ä¸º `oapi.dingtalk.com/media/upload`
2. ä¿®æ­£æ¶ˆæ¯ç±»åž‹ï¼šä»Ž `image` æ”¹ä¸º `sampleImageMsg`
3. ä¿®æ­£å‚æ•°å­—æ®µï¼šä»Ž `imageKey` æ”¹ä¸º `photoURL`
4. é€æ­¥æµ‹è¯•éªŒè¯æ¯ä¸ªä¿®æ”¹
5. ç¡®è®¤å›¾ç‰‡åœ¨é’‰é’‰ä¸­æ­£å¸¸æ˜¾ç¤º

**å…³é”®å› ç´ **
- ä»”ç»†é˜…è¯»å®˜æ–¹æ–‡æ¡£
- é€æ­¥æµ‹è¯•æ¯ä¸ªä¿®æ”¹
- ä¿æŒAPIè°ƒç”¨ä¸€è‡´æ€§
- å‚è€ƒå®˜æ–¹ç¤ºä¾‹ä»£ç 

**ä»£ç ç¤ºä¾‹**
```javascript
// æ­£ç¡®çš„å›¾ç‰‡å‘é€æ–¹å¼
const axios = require('axios');
const fs = require('fs');

async function sendDingTalkImage(webhookUrl, imagePath, accessToken) {
  try {
    // 1. ä¸Šä¼ å›¾ç‰‡åˆ°é’‰é’‰æœåŠ¡å™¨ï¼ˆä½¿ç”¨æ—§ç‰ˆAPIï¼‰
    const uploadUrl = `https://oapi.dingtalk.com/media/upload?access_token=${accessToken}&type=image`;
    const formData = new FormData();
    formData.append('media', fs.createReadStream(imagePath));

    const uploadResponse = await axios.post(uploadUrl, formData, {
      headers: formData.getHeaders()
    });

    if (uploadResponse.data.errcode !== 0) {
      throw new Error(`Upload failed: ${uploadResponse.data.errmsg}`);
    }

    const media_id = uploadResponse.data.media_id;
    
    // 2. å‘é€å›¾ç‰‡æ¶ˆæ¯ï¼ˆä½¿ç”¨æ­£ç¡®çš„ msgtype å’Œå‚æ•°ï¼‰
    const msg = {
      msgtype: "sampleImageMsg",  // å…³é”®ï¼šä½¿ç”¨ sampleImageMsg
      sampleImageMsg: {
        photoURL: media_id  // å…³é”®ï¼šä½¿ç”¨ photoURL è€Œéž imageKey
      }
    };
    
    await axios.post(webhookUrl, msg);
    console.log('Image sent successfully');
  } catch (error) {
    console.error('Error sending image:', error.message);
  }
}
```

---

### æˆåŠŸ2ï¼šç½‘å…³ä»¤ç‰Œé…ç½®ä¿®å¤
**æˆåŠŸæ­¥éª¤**
1. è¯†åˆ«ä»¤ç‰Œé…ç½®åˆ†æ•£é—®é¢˜ï¼ˆé…ç½®æ–‡ä»¶ã€çŽ¯å¢ƒå˜é‡ã€systemdæœåŠ¡æ–‡ä»¶ï¼‰
2. ç»Ÿä¸€ä»¤ç‰Œé…ç½®åˆ°æ‰€æœ‰ä½ç½®
3. æ›´æ–°é…ç½®æ–‡ä»¶æ·»åŠ  `gateway.remote.token` å­—æ®µ
4. ä½¿ç”¨æ­£ç¡®çš„systemdå‘½ä»¤é‡å¯æœåŠ¡
5. éªŒè¯æœåŠ¡çŠ¶æ€ä¸ºactive

**å…³é”®å› ç´ **
- ä»¤ç‰Œé…ç½®åœ¨æ‰€æœ‰ä½ç½®ä¿æŒä¸€è‡´
- ä½¿ç”¨systemdæœåŠ¡ç®¡ç†å‘½ä»¤
- é‡å¯åŽéªŒè¯æœåŠ¡çŠ¶æ€
- é¿å…ä½¿ç”¨ `pkill` æ‰‹åŠ¨æ€æ­»è¿›ç¨‹

**å‘½ä»¤ç¤ºä¾‹**
```bash
# 1. ç¼–è¾‘é…ç½®æ–‡ä»¶
vi ~/.clawdbot/clawdbot.json

# ç¡®ä¿åŒ…å«ä»¥ä¸‹é…ç½®ï¼š
# {
#   "gateway": {
#     "auth": {
#       "mode": "token",
#       "token": "your_correct_token"
#     },
#     "remote": {
#       "token": "your_correct_token"  // å¿…é¡»ä¸Ž auth.token ä¸€è‡´
#     }
#   }
# }

# 2. é‡å¯ç½‘å…³æœåŠ¡ï¼ˆä½¿ç”¨æ­£ç¡®çš„systemdå‘½ä»¤ï¼‰
clawdbot gateway stop
clawdbot gateway start

# 3. éªŒè¯æœåŠ¡çŠ¶æ€
clawdbot gateway status

# 4. æŸ¥çœ‹æœåŠ¡æ—¥å¿—
journalctl --user -u clawdbot-gateway -n 50
```

---

### ðŸ’¡ é‡è¦æŠ€èƒ½å’ŒçŸ¥è¯†


### DingTalk APIè°ƒç”¨èƒ½åŠ›
**æ­£ç¡®çš„APIç«¯ç‚¹**
- å›¾ç‰‡ä¸Šä¼ ï¼š`https://oapi.dingtalk.com/media/upload`
- æ¶ˆæ¯å‘é€ï¼š`https://oapi.dingtalk.com/robot/send`
- èŽ·å–access_tokenï¼š`https://oapi.dingtalk.com/gettoken`

**æ¶ˆæ¯ç±»åž‹**
- å›¾ç‰‡æ¶ˆæ¯ï¼š`sampleImageMsg`ï¼ˆæ³¨æ„ä¸æ˜¯ `image`ï¼‰
- Markdownæ¶ˆæ¯ï¼š`markdown`
- é“¾æŽ¥æ¶ˆæ¯ï¼š`link`
- æ–‡æœ¬æ¶ˆæ¯ï¼š`text`

**å…³é”®å‚æ•°**
- `sampleImageMsg` éœ€è¦ `photoURL` å­—æ®µï¼ˆmedia_idå€¼ï¼‰
- ä¸è¦ä½¿ç”¨ `imageKey` æˆ– `sampleImage`

**é…ç½®ç®¡ç†**
```javascript
// Clawdboté…ç½®ç¤ºä¾‹
{
  "channels": {
    "dingtalk": {
      "enabled": true,
      "appKey": "your_app_key",
      "appSecret": "your_app_secret",
      "groupPolicy": "open",
      "dmPolicy": "open"
    }
  }
}
```

---

### ðŸ“Š å¤±è´¥åŽŸå› åˆ†æž


### æ ¹æœ¬åŽŸå› æ€»ç»“
| å¤±è´¥ç±»åž‹ | æ ¹æœ¬åŽŸå›  | é¢‘æ¬¡ |
|---------|---------|------|
| APIç«¯ç‚¹é”™è¯¯ | æ··æ·†æ–°ç‰ˆå’Œæ—§ç‰ˆAPIç«¯ç‚¹ | 1æ¬¡ |
| æ¶ˆæ¯ç±»åž‹é”™è¯¯ | æœªä»”ç»†é˜…è¯»å®˜æ–¹æ–‡æ¡£çš„å‚æ•°å®šä¹‰ | 2æ¬¡ |
| å‚æ•°å­—æ®µé”™è¯¯ | å‚æ•°åç§°æ‹¼å†™é”™è¯¯æˆ–ä½¿ç”¨äº†è¿‡æ—¶çš„å­—æ®µå | 1æ¬¡ |
| ä»¤ç‰Œé…ç½®é”™è¯¯ | é…ç½®åˆ†æ•£åœ¨å¤šä¸ªä½ç½®ä¸”æœªåŒæ­¥æ›´æ–° | 10+æ¬¡ |
| æœåŠ¡ç®¡ç†é”™è¯¯ | ä½¿ç”¨æ‰‹åŠ¨è¿›ç¨‹æ€æ­»è€Œéžsystemdå‘½ä»¤ | 5æ¬¡ |

---

### ðŸŽ¯ æœ€ä½³å®žè·µ


### 1. DingTalké›†æˆ
1. **æ–‡æ¡£ä¼˜å…ˆ**
   - å§‹ç»ˆä»Žå®˜æ–¹æ–‡æ¡£å¼€å§‹
   - éªŒè¯APIç‰ˆæœ¬å…¼å®¹æ€§
   - å‚è€ƒå®˜æ–¹ç¤ºä¾‹ä»£ç 

2. **æ¸è¿›å¼æµ‹è¯•**
   - æ¯æ¬¡åªä¿®æ”¹ä¸€ä¸ªé—®é¢˜
   - ä¿®æ”¹åŽç«‹å³æµ‹è¯•éªŒè¯
   - ä¿ç•™å¯å›žæ»šçš„å¤‡ä»½

3. **å‚æ•°éªŒè¯**
   - ä»”ç»†æ£€æŸ¥å‚æ•°åç§°æ‹¼å†™
   - éªŒè¯å‚æ•°å€¼æ ¼å¼
   - ä½¿ç”¨æ­£ç¡®çš„æ•°æ®ç±»åž‹

### 2. é…ç½®ç®¡ç†
1. **é…ç½®ä¸€è‡´æ€§**
   - ä»¤ç‰Œå’Œå¯†é’¥åœ¨æ‰€æœ‰ä½ç½®ä¿æŒä¸€è‡´
   - é…ç½®æ–‡ä»¶å’ŒçŽ¯å¢ƒå˜é‡åŒæ­¥
   - ä½¿ç”¨ç‰ˆæœ¬æŽ§åˆ¶ç®¡ç†é…ç½®å˜æ›´

2. **æœåŠ¡ç®¡ç†**
   - ä½¿ç”¨systemdå‘½ä»¤ç®¡ç†æœåŠ¡
   - é¿å…æ‰‹åŠ¨æ€æ­»è¿›ç¨‹
   - é‡å¯åŽéªŒè¯æœåŠ¡çŠ¶æ€

3. **æ—¥å¿—ç›‘æŽ§**
   - å¯ç”¨è¯¦ç»†æ—¥å¿—è®°å½•
   - åˆ†æžæ—¥å¿—ä¸­çš„é”™è¯¯ä»£ç 
   - ä½¿ç”¨æ—¥å¿—å®šä½é—®é¢˜æ ¹æº

---

*æ–‡æ¡£åˆ›å»ºæ—¶é—´ï¼š2026-02-15*
*åŸºäºŽClawdbotå¯¹è¯è®°å½•æ•´ç†å®Œæˆ*