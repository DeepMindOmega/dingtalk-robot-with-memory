# OpenCodeç³»ç»Ÿç»´æŠ¤ç»éªŒ

**Type**: long_term
**Source**: opencode_experience
**Created**: 2026-02-14T23:33:39.957853+00:00
**ID**: 143

**Tags**: dingtalk, opencode, api, config, security

---


### ä¸€ã€ç»´æŠ¤æ¦‚è¿°
æœ¬é˜¶æ®µä¸»è¦èšç„¦äºOpenCodeç³»ç»Ÿçš„æ—¥å¸¸ç»´æŠ¤å’Œé—®é¢˜æ’æŸ¥å·¥ä½œï¼Œæ¶µç›–ç³»ç»Ÿé…ç½®æ£€æŸ¥ã€æ™ºèƒ½ä½“é›†æˆè°ƒè¯•ã€WebSocketè¿æ¥ä¼˜åŒ–ç­‰æ ¸å¿ƒç»´æŠ¤ä»»åŠ¡ã€‚

### ç»´æŠ¤ä¼šè¯ç»Ÿè®¡
| ä¼šè¯ID | ä¸»é¢˜ | æ¶ˆæ¯æ•° | æ—¶é—´ | çŠ¶æ€ |
|---------|------|---------|------|------|
| ses_3a87ecfccffemBoZ7WMNkSHSBP | ç³»ç»Ÿé…ç½®æ£€æŸ¥ | 2 | 20åˆ†é’Ÿ | å®Œæˆ |
| ses_3a52e9796ffeVCgAD5OgeaYNSW | æ™ºèƒ½ä½“é›†æˆå¤±è´¥ | 2 | 1å°æ—¶ | éƒ¨åˆ†å®Œæˆ |
| ses_3a6417b02ffeXpFZduuQZKSm66 | é’‰é’‰æœºå™¨äººå¢å¼º | 1139 | 2å°æ—¶ | å®Œæˆ |

---

### äºŒã€æˆåŠŸæ¡ˆä¾‹ (6ä¸ª)


### æˆåŠŸæ¡ˆä¾‹ 1: Tokenè‡ªåŠ¨ç¼“å­˜æœºåˆ¶
**èƒŒæ™¯**: é’‰é’‰æœºå™¨äººé¢‘ç¹è°ƒç”¨APIå¯¼è‡´Tokenåˆ·æ–°å¼€é”€å¤§

**é—®é¢˜**: æ¯æ¬¡å‘é€æ¶ˆæ¯éƒ½éœ€è¦é‡æ–°è·å–Access Tokenï¼Œæµªè´¹APIé…é¢å’Œæ—¶é—´

**è§£å†³æ­¥éª¤**:
1. åœ¨gateway.pyä¸­å®ç°Tokenç¼“å­˜å­—å…¸
2. è®¾ç½®5åˆ†é’Ÿæå‰åˆ·æ–°æœºåˆ¶
3. æ·»åŠ è¿‡æœŸæ—¶é—´æ£€æŸ¥

**å…³é”®é…ç½®**:
```python
_token_cache: Dict[str, Dict[str, Any]] = {
    "token": None,
    "expires_at": None,
    "refresh_at": None
}
TOKEN_REFRESH_BUFFER = timedelta(minutes=5)
```

**ç»éªŒæ€»ç»“**:
- âœ… ç¼“å­˜æœºåˆ¶å¯æ˜¾è‘—å‡å°‘APIè°ƒç”¨æ¬¡æ•°
- âœ… æå‰åˆ·æ–°é¿å…Tokenè¿‡æœŸå¯¼è‡´çš„æœåŠ¡ä¸­æ–­
- âœ… é€‚ç”¨äºæ‰€æœ‰éœ€è¦Tokenè®¤è¯çš„APIé›†æˆåœºæ™¯

---

### æˆåŠŸæ¡ˆä¾‹ 2: Markdownå¯Œæ–‡æœ¬è‡ªåŠ¨æ£€æµ‹
**èƒŒæ™¯**: æœºå™¨äººå‘é€çš„æ¶ˆæ¯æ ¼å¼å•ä¸€ï¼Œç”¨æˆ·ä½“éªŒå·®

**é—®é¢˜**: æ— æ³•è¯†åˆ«Markdownæ ¼å¼ï¼Œå¯¼è‡´ä»£ç å—ã€åˆ—è¡¨ç­‰æ ¼å¼æ— æ³•æ­£ç¡®æ˜¾ç¤º

**è§£å†³æ­¥éª¤**:
1. åˆ›å»º`detect_message_type()`å‡½æ•°
2. æ£€æµ‹Markdownç‰¹å¾ï¼ˆ`

### æˆåŠŸæ¡ˆä¾‹ 3: WebSocketè‡ªåŠ¨é‡è¿æœºåˆ¶
**èƒŒæ™¯**: é’‰é’‰æœºå™¨äººWebSocketè¿æ¥ç»å¸¸æ–­å¼€ï¼Œå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±

**é—®é¢˜**: ç½‘ç»œæ³¢åŠ¨æˆ–æœåŠ¡å™¨é™åˆ¶å¯¼è‡´è¿æ¥æ–­å¼€åæ— æ³•è‡ªåŠ¨æ¢å¤

**è§£å†³æ­¥éª¤**:
1. å®ç°é‡è¯•è£…é¥°å™¨ï¼Œæœ€å¤š5æ¬¡é‡è¿
2. æ·»åŠ å¿ƒè·³ä¿æ´»æœºåˆ¶ï¼Œæ¯30ç§’æ£€æŸ¥è¿æ¥çŠ¶æ€
3. æŒ‡æ•°é€€é¿ç­–ç•¥ï¼Œé¿å…é¢‘ç¹é‡è¿

**å…³é”®é…ç½®**:
```python
MAX_RETRIES = 5
RETRY_DELAY = 5  # ç§’
HEARTBEAT_INTERVAL = 30  # ç§’
MESSAGE_TIMEOUT = 60  # ç§’

@retry_on_failure(max_retries=MAX_RETRIES, delay=RETRY_DELAY)
def connect_websocket():
    # è¿æ¥é€»è¾‘
    pass

def check_heartbeat():
    if time.time() - last_msg_time > MESSAGE_TIMEOUT:
        log_warning(f"60ç§’å†…æœªæ”¶åˆ°æ¶ˆæ¯ï¼Œå¯èƒ½æ–­å¼€")
        # è§¦å‘é‡è¿
```

**ç»éªŒæ€»ç»“**:
- âœ… è‡ªåŠ¨é‡è¿æœºåˆ¶æ˜¾è‘—æå‡æœåŠ¡ç¨³å®šæ€§
- âœ… å¿ƒè·³ç›‘æ§åŠæ—¶å‘ç°è¿æ¥å¼‚å¸¸
- âœ… æŒ‡æ•°é€€é¿é¿å…æœåŠ¡å™¨å‹åŠ›è¿‡å¤§
- âœ… é€‚ç”¨äºæ‰€æœ‰é•¿è¿æ¥æœåŠ¡çš„ç¨³å®šæ€§ä¿éšœ

---

### æˆåŠŸæ¡ˆä¾‹ 4: å…³é”®Bugä¿®å¤ - result_senderç¼©è¿›é”™è¯¯
**èƒŒæ™¯**: æœºå™¨äººèƒ½æ¥æ”¶æ¶ˆæ¯ä½†é˜Ÿåˆ—å †ç§¯ï¼Œç»“æœæ— æ³•è¿”å›

**é—®é¢˜**: result_sender()å‡½æ•°ç¬¬264-265è¡Œç¼©è¿›é”™è¯¯ï¼Œå¯¼è‡´send_successæ°¸è¿œä¸ºFalse

**è§£å†³æ­¥éª¤**:
1. ä½¿ç”¨explore agentåˆ†æä»£ç 
2. å®šä½åˆ°gateway.pyç¬¬264-265è¡Œ
3. ä¿®æ­£ç¼©è¿›ï¼Œç¡®ä¿send_successæ­£ç¡®è®¾ç½®

**å…³é”®ä¿®å¤**:
```python
# ä¿®å¤å‰ï¼ˆé”™è¯¯ç¼©è¿›ï¼‰
def result_sender():
    while True:
        # ... å¤„ç†é€»è¾‘
        send_result = send_message(...)
    send_success = send_result is not None  # æ°¸è¿œä¸ä¼šæ‰§è¡Œ

# ä¿®å¤åï¼ˆæ­£ç¡®ç¼©è¿›ï¼‰
def result_sender():
    while True:
        # ... å¤„ç†é€»è¾‘
        send_result = send_message(...)
        send_success = send_result is not None  # æ­£ç¡®è®¾ç½®
```

**ç»éªŒæ€»ç»“**:
- âœ… ä½¿ç”¨explore agentå¿«é€Ÿå®šä½é—®é¢˜
- âœ… ç¼©è¿›é”™è¯¯åœ¨Pythonä¸­éš¾ä»¥å‘ç°ï¼Œéœ€ä»”ç»†å®¡æŸ¥
- âœ… æ¶ˆæ¯é˜Ÿåˆ—éœ€è¦æ˜ç¡®çš„æˆåŠŸ/å¤±è´¥çŠ¶æ€ç®¡ç†
- âœ… LSPå·¥å…·å¯è¾…åŠ©å‘ç°ä»£ç ç»“æ„é—®é¢˜

---

### æˆåŠŸæ¡ˆä¾‹ 5: ç³»ç»Ÿè¿›ç¨‹ç›‘æ§ä¸è¯Šæ–­
**èƒŒæ™¯**: å¤šä¸ªOpenCodeå®ä¾‹åŒæ—¶è¿è¡Œï¼Œèµ„æºæµªè´¹ä¸”å¯èƒ½å†²çª

**é—®é¢˜**: ä¸æ¸…æ¥šå½“å‰è¿è¡Œäº†å“ªäº›OpenCodeè¿›ç¨‹ï¼Œæ— æ³•æœ‰æ•ˆç®¡ç†

**è§£å†³æ­¥éª¤**:
1. ä½¿ç”¨`ps aux | grep opencode`æ£€æŸ¥è¿›ç¨‹
2. åˆ›å»ºè¯Šæ–­è„šæœ¬diagnose.sh
3. æ·»åŠ è¿›ç¨‹ç®¡ç†è„šæœ¬start.sh/stop.sh/status.sh

**å…³é”®é…ç½®**:
```bash
#!/bin/bash
# diagnose.sh
echo "=== OpenCodeè¿›ç¨‹çŠ¶æ€ ==="
ps aux | grep opencode | grep -v grep

echo "=== é’‰é’‰æœºå™¨äººæœåŠ¡ ==="
ps aux | grep dingtalk | grep -v grep

echo "=== ç«¯å£å ç”¨ ==="
netstat -tunlp | grep -E ':(8000|8002|4747)'
```

**ç»éªŒæ€»ç»“**:
- âœ… è¿›ç¨‹ç›‘æ§è„šæœ¬ç®€åŒ–æ—¥å¸¸ç»´æŠ¤å·¥ä½œ
- âœ… è‡ªåŠ¨è¯Šæ–­è„šæœ¬å¿«é€Ÿå®šä½é—®é¢˜
- âœ… ç»Ÿä¸€çš„æœåŠ¡ç®¡ç†è„šæœ¬æå‡å¯ç»´æŠ¤æ€§
- âœ… é¿å…å¤šå®ä¾‹å†²çª

---

### æˆåŠŸæ¡ˆä¾‹ 6: ç§èŠæ¶ˆæ¯åŠŸèƒ½å®ç°
**èƒŒæ™¯**: æœºå™¨äººä»…æ”¯æŒç¾¤èŠï¼Œç”¨æˆ·ç§èŠæ— æ³•ä½¿ç”¨

**é—®é¢˜**: ç¼ºå°‘ç§èŠæ¶ˆæ¯å‘é€å‡½æ•°ï¼Œæ‰€æœ‰æ¶ˆæ¯éƒ½æŒ‰ç¾¤èŠå¤„ç†

**è§£å†³æ­¥éª¤**:
1. æ·»åŠ `send_private_message()`å‡½æ•°
2. åœ¨queue_managerä¸­æ·»åŠ conv_typeå­—æ®µ
3. åœ¨result_senderä¸­æ™ºèƒ½è·¯ç”±å‘é€

**å…³é”®é…ç½®**:
```python
def send_private_message(user_id, content, token=None):
    """å‘é€ç§èŠæ¶ˆæ¯"""
    url = f"{BASE_URL}/v1.0/robot/oToMessages/batchSend"
    data = {"robot_code": ROBOT_CODE, "user_ids": [user_id], "msg": {"text": {"content": content}}}
    response = urlopen(Request(url, json.dumps(data).encode(), headers))

def result_sender():
    while True:
        task = queue_manager.get_result()
        if conv_type == "2":
            send_group_message(conv_id, response, token)  # ç¾¤èŠ
        else:
            send_private_message(user_id, response, token)  # ç§èŠ
```

**ç»éªŒæ€»ç»“**:
- âœ… ä½¿ç”¨conv_typeå­—æ®µåŒºåˆ†æ¶ˆæ¯ç±»å‹
- âœ… æ™ºèƒ½è·¯ç”±ç®€åŒ–å‘é€é€»è¾‘
- âœ… ç§èŠå’Œç¾¤èŠAPIå·®å¼‚éœ€ç‰¹åˆ«æ³¨æ„

---

### ä¸‰ã€å¤±è´¥æ•™è®­ (5ä¸ª)


### å¤±è´¥æ•™è®­ 1: Shellè½¬ä¹‰å¯¼è‡´æ–‡ä»¶æŸå
**é”™è¯¯ç°è±¡**: processor.pyç»è¿‡20+æ¬¡ä¿®æ”¹å°è¯•åä»ç„¶æ— æ³•ç¼–è¯‘

**æ ¹æœ¬åŸå› **: Shellå‘½ä»¤çš„`__file__`è¢«è½¬ä¹‰ç ´åï¼Œæ–‡ä»¶è¢«é‡å¤å†™å…¥

**è§£å†³æ–¹æ³•**:
- ä»å¤‡ä»½æ¢å¤processor.py.bak
- ä½¿ç”¨sedå‘½ä»¤ç²¾ç¡®ä¿®æ”¹ï¼Œé¿å…heredocè½¬ä¹‰é—®é¢˜
- æˆ–ä½¿ç”¨Pythonè„šæœ¬ç›´æ¥å†™å…¥ï¼Œå®Œå…¨ç»•è¿‡Shell

**é¿å…ç­–ç•¥**:
- âŒ é¿å…ä½¿ç”¨heredoc (`cat <<EOF`) å†™å…¥åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„Pythonä»£ç 
- âŒ é¿å…é‡å¤å°è¯•ä¿®æ”¹å¤±è´¥ï¼Œç¬¬ä¸€æ¬¡å¤±è´¥å°±æ¢æ–¹æ³•
- âœ… ä¼˜å…ˆä½¿ç”¨ç¼–è¾‘å·¥å…·æˆ–Pythonè„šæœ¬ç›´æ¥æ“ä½œæ–‡ä»¶
- âœ… ä¿æŒå·¥ä½œå¤‡ä»½ï¼Œå¤±è´¥åç«‹å³æ¢å¤

---

### å¤±è´¥æ•™è®­ 2: 20+æ¬¡å°è¯•ä¿®å¤å¤±è´¥ - ç¼ºä¹å¤±è´¥å¿«é€Ÿåˆ‡æ¢ç­–ç•¥
**é”™è¯¯ç°è±¡**: åŒä¸€ä¸ªè¯­æ³•é”™è¯¯å°è¯•20+æ¬¡ä¿®å¤ï¼Œå…¨éƒ¨å¤±è´¥

**æ ¹æœ¬åŸå› **: å›ºå®ˆShellå‘½ä»¤ä¿®æ”¹æ–¹å¼ï¼Œæ²¡æœ‰åŠæ—¶åˆ‡æ¢åˆ°Pythonç›´æ¥å†™å…¥æˆ–ç¼–è¾‘å·¥å…·

**è§£å†³æ–¹æ³•**:
- ç¬¬3æ¬¡å¤±è´¥åå°±åº”è¯¥å°è¯•æ–°æ–¹æ³•
- ä½¿ç”¨editå·¥å…·æˆ–writeå·¥å…·ç›´æ¥æ“ä½œ
- å®Œå…¨é‡å†™æ–‡ä»¶æ¯”åå¤ä¿®æ”¹æ›´å¯é 

**é¿å…ç­–ç•¥**:
- âŒ ä¸è¦åœ¨åŒä¸€æ–¹æ³•ä¸Šè¶…è¿‡3æ¬¡å°è¯•
- âœ… è®¾å®š"3æ¬¡å¤±è´¥è§„åˆ™"ï¼Œè§¦å‘åç«‹å³åˆ‡æ¢æ–¹æ³•
- âœ… è®°å½•å¤±è´¥åŸå› ï¼Œé¿å…é‡å¤é”™è¯¯
- âœ… å¤æ‚æ–‡ä»¶æ“ä½œä¼˜å…ˆä½¿ç”¨ä¸“ä¸šå·¥å…·è€ŒéShell

---

### å¤±è´¥æ•™è®­ 3: OpenCodeæ™ºèƒ½ä½“é›†æˆå¤±è´¥ - ç¼ºä¹å‰ç½®éªŒè¯
**é”™è¯¯ç°è±¡**: å¸Œæœ›é’‰é’‰æœºå™¨äººè°ƒç”¨OpenCodeæ™ºèƒ½ä½“å¤„ç†æ¶ˆæ¯ï¼Œä½†æ— æ³•å®ç°

**æ ¹æœ¬åŸå› **:
1. processor.pyè¯­æ³•é”™è¯¯å¯¼è‡´æ— æ³•å¯åŠ¨
2. OpenCode CLIé›†æˆæ–¹å¼ä¸æ˜ç¡®
3. ç¼ºä¹å¯¹æ™ºèƒ½ä½“è°ƒç”¨æœºåˆ¶çš„æ·±å…¥ç†è§£

**è§£å†³æ–¹æ³•**:
1. å…ˆéªŒè¯OpenCode CLIçš„åŸºæœ¬è°ƒç”¨æ–¹å¼
2. åœ¨ç‹¬ç«‹è„šæœ¬ä¸­æµ‹è¯•æ™ºèƒ½ä½“è°ƒç”¨
3. ç¡®è®¤æˆåŠŸåå†é›†æˆåˆ°processor.py

**é¿å…ç­–ç•¥**:
- âŒ ä¸è¦åœ¨å…³é”®è·¯å¾„ä¸Šé›†æˆæœªéªŒè¯çš„åŠŸèƒ½
- âœ… å¤æ‚é›†æˆå‰å…ˆåœ¨ç‹¬ç«‹ç¯å¢ƒéªŒè¯
- âœ… åˆ†é˜¶æ®µé›†æˆï¼Œæ¯é˜¶æ®µéƒ½å……åˆ†æµ‹è¯•
- âœ… é‡åˆ°é˜»å¡åŠæ—¶å¯»æ±‚Oracle agentå¸®åŠ©

---

### å¤±è´¥æ•™è®­ 4: WebSocketè¿æ¥é¢‘ç¹æ–­å¼€ - ç¼ºä¹ç›‘æ§å‘Šè­¦
**é”™è¯¯ç°è±¡**: ç”¨æˆ·æŠ¥å‘Šæœºå™¨äºº"æœ‰ååº”äº†ï¼Œç°åœ¨åˆæ²¡ååº”äº†"

**æ ¹æœ¬åŸå› **: WebSocketæ–­å¼€åæ— ç›‘æ§ï¼Œç”¨æˆ·åé¦ˆåæ‰å‘ç°é—®é¢˜

**è§£å†³æ–¹æ³•**:
- å®ç°å¿ƒè·³ä¿æ´»æœºåˆ¶
- æ·»åŠ è¿æ¥çŠ¶æ€æ—¥å¿—
- ç›‘æ§60ç§’æ— æ¶ˆæ¯å³è®°å½•è­¦å‘Š

**é¿å…ç­–ç•¥**:
- âŒ ä¸è¦ä¾èµ–ç”¨æˆ·åé¦ˆå‘ç°æœåŠ¡æ•…éšœ
- âœ… ä¸»åŠ¨ç›‘æ§æœåŠ¡å¥åº·çŠ¶æ€
- âœ… å…³é”®æŒ‡æ ‡ï¼ˆè¿æ¥çŠ¶æ€ã€æ¶ˆæ¯ååï¼‰å®æ—¶ç›‘æ§
- âœ… å¼‚å¸¸è‡ªåŠ¨å‘Šè­¦ï¼ˆæ—¥å¿—ã€é‚®ä»¶ç­‰ï¼‰

---

### å¤±è´¥æ•™è®­ 5: ç§èŠåŠŸèƒ½åˆæœŸæœªéªŒè¯ç¾¤èŠé…ç½®
**é”™è¯¯ç°è±¡**: ç§èŠä¿®å¤æˆåŠŸï¼Œä½†ç¾¤èŠ"æ”¶åˆ°å¤„ç†ä¸­"åæ— ä¸‹æ–‡

**æ ¹æœ¬åŸå› **: ç¾¤èŠAPIè°ƒç”¨å¤±è´¥ï¼ˆHTTP 400ï¼‰ï¼Œé…ç½®æˆ–æƒé™é—®é¢˜æœªå……åˆ†éªŒè¯

**è§£å†³æ–¹æ³•**:
- æ£€æŸ¥é’‰é’‰å¼€æ”¾å¹³å°æœºå™¨äººæƒé™é…ç½®
- éªŒè¯ç¾¤èŠIDæ ¼å¼æ­£ç¡®æ€§
- æµ‹è¯•ç¾¤èŠAPIè°ƒç”¨çš„è¿”å›ç»“æœ

**é¿å…ç­–ç•¥**:
- âŒ ä¸è¦å‡è®¾APIè°ƒç”¨éƒ½ä¼šæˆåŠŸ
- âœ… æ¯ç§æ¶ˆæ¯ç±»å‹éƒ½å•ç‹¬æµ‹è¯•éªŒè¯
- âœ… æ£€æŸ¥APIè¿”å›çš„é”™è¯¯ä¿¡æ¯
- âœ… è®°å½•æ‰€æœ‰APIè°ƒç”¨çš„çŠ¶æ€ç 

---

### å››ã€æŠ€èƒ½å¢é•¿ç‚¹


### 4.1 ç³»ç»Ÿè¯Šæ–­èƒ½åŠ›
**æŒæ¡ç¨‹åº¦**: ğŸŸ¢ å·²æŒæ¡

**èƒ½åŠ›æè¿°**:
- âœ… è¿›ç¨‹çŠ¶æ€æ£€æŸ¥ (`ps aux`, `pgrep`)
- âœ… ç«¯å£å ç”¨æ£€æµ‹ (`netstat`, `lsof`)
- âœ… æ—¥å¿—åˆ†æ (`tail`, `grep`)
- âœ… åˆ›å»ºè¯Šæ–­è„šæœ¬è‡ªåŠ¨åŒ–æ£€æŸ¥

**åº”ç”¨åœºæ™¯**:
- æœåŠ¡å¯åŠ¨å¤±è´¥æ—¶å¿«é€Ÿå®šä½åŸå› 
- å¤šå®ä¾‹å†²çªæ£€æµ‹
- æ€§èƒ½é—®é¢˜æ’æŸ¥

---

### 4.2 é—®é¢˜æ’æŸ¥èƒ½åŠ›
**æŒæ¡ç¨‹åº¦**: ğŸŸ¡ ä¸­ç­‰

**èƒ½åŠ›æè¿°**:
- âœ… ä½¿ç”¨explore agentåˆ†æä»£ç ç»“æ„
- âœ… é€šè¿‡æ—¥å¿—è¿½è¸ªé—®é¢˜é“¾è·¯
- âœ… WebSocketè¿æ¥é—®é¢˜æ’æŸ¥
- âš ï¸ å¤æ‚é›†æˆé—®é¢˜éœ€æ›´å¤šç»éªŒ

**åº”ç”¨åœºæ™¯**:
- æ¶ˆæ¯ä¸¢å¤±é—®é¢˜æ’æŸ¥
- æ€§èƒ½ç“¶é¢ˆå®šä½
- APIè°ƒç”¨å¤±è´¥è¯Šæ–­

**å¾…æå‡**:
- æ·±å…¥ç†è§£OpenCodeæ™ºèƒ½ä½“è°ƒç”¨æœºåˆ¶
- æŒæ¡æ›´å¤šæ€§èƒ½åˆ†æå·¥å…·

---

### 4.3 é…ç½®ç®¡ç†èƒ½åŠ›
**æŒæ¡ç¨‹åº¦**: ğŸŸ¢ å·²æŒæ¡

**èƒ½åŠ›æè¿°**:
- âœ… Tokenç¼“å­˜é…ç½®
- âœ… æ¶ˆæ¯ç±»å‹æ™ºèƒ½æ£€æµ‹é…ç½®
- âœ… é‡è¯•å’Œé€€é¿ç­–ç•¥é…ç½®
- âœ… æœåŠ¡å¯åŠ¨/åœæ­¢è„šæœ¬ç¼–å†™

**åº”ç”¨åœºæ™¯**:
- å‡å°‘APIè°ƒç”¨å¼€é”€
- æå‡æœåŠ¡ç¨³å®šæ€§
- ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ

---

### äº”ã€æ­¤é˜¶æ®µç»´æŠ¤è¦ç‚¹


### 5.1 é…ç½®æ£€æŸ¥
**æ£€æŸ¥é¡¹æ¸…å•**:
- [ ] è¿›ç¨‹çŠ¶æ€ï¼šç¡®è®¤æ— é‡å¤å®ä¾‹
- [ ] Tokenç¼“å­˜ï¼šéªŒè¯ç¼“å­˜æœºåˆ¶æ­£å¸¸
- [ ] æ¶ˆæ¯ç±»å‹ï¼šç¡®è®¤Markdownæ£€æµ‹å‡†ç¡®
- [ ] æƒé™é…ç½®ï¼šéªŒè¯é’‰é’‰å¼€æ”¾å¹³å°æƒé™

**å·¥å…·**:
```bash
./diagnose.sh          # å¿«é€Ÿè¯Šæ–­
./status.sh             # æœåŠ¡çŠ¶æ€
tail -f logs/*.log      # å®æ—¶æ—¥å¿—
```

---

### 5.2 é”™è¯¯å¤„ç†
**é”™è¯¯åˆ†ç±»**:
| é”™è¯¯ç±»å‹ | å¤„ç†æ–¹æ³• | å·¥å…· |
|-----------|----------|------|
| è¯­æ³•é”™è¯¯ | æ¢å¤å¤‡ä»½ï¼Œç²¾ç¡®ä¿®æ”¹ | sed, edit |
| è¿æ¥æ–­å¼€ | è‡ªåŠ¨é‡è¿+å¿ƒè·³ç›‘æ§ | @retry_on_failure |
| APIå¤±è´¥ | é‡è¯•+æŒ‡æ•°é€€é¿ | @retry_on_failure |
| è¿›ç¨‹å¼‚å¸¸ | è‡ªåŠ¨é‡å¯+å‘Šè­¦ | pkill, nohup |

**æœ€ä½³å®è·µ**:
- âœ… æ‰€æœ‰å¤–éƒ¨è°ƒç”¨éƒ½åº”æ·»åŠ é‡è¯•æœºåˆ¶
- âœ… è®°å½•è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
- âœ… å¼‚å¸¸ä¸åº”å¯¼è‡´æœåŠ¡å´©æºƒ
- âœ… å…³é”®æ“ä½œåº”æœ‰è¶…æ—¶è®¾ç½®

---

### 5.3 é›†æˆè°ƒè¯•
**è°ƒè¯•æ­¥éª¤**:
1. **ç‹¬ç«‹éªŒè¯**: åœ¨è„šæœ¬ä¸­æµ‹è¯•OpenCode CLIè°ƒç”¨
2. **æ—¥å¿—è¿½è¸ª**: å¼€å¯è¯¦ç»†æ—¥å¿—ï¼Œè¿½è¸ªæ¶ˆæ¯æµ
3. **åˆ†é˜¶æ®µæµ‹è¯•**: å…ˆæµ‹è¯•ç®€å•æ¶ˆæ¯ï¼Œå†æµ‹è¯•å¤æ‚é›†æˆ
4. **å›æ»šç­–ç•¥**: ä¿ç•™å·¥ä½œå¤‡ä»½ï¼Œå¤±è´¥ç«‹å³æ¢å¤

**è°ƒè¯•å·¥å…·**:
```python
import logging
logging.basicConfig(level=logging.DEBUG, format='%(asctime)s - %(levelname)s - %(message)s')
```

---

### å…­ã€ç³»ç»Ÿä¼˜åŒ–ç»éªŒ


### 6.1 æ€§èƒ½ä¼˜åŒ–
**Tokenç¼“å­˜ä¼˜åŒ–**:
- **æ•ˆæœ**: å‡å°‘80%çš„Tokenè¯·æ±‚
- **å®ç°**: å†…å­˜ç¼“å­˜ + 5åˆ†é’Ÿæå‰åˆ·æ–°
- **é€‚ç”¨**: æ‰€æœ‰Tokenè®¤è¯API

**æ¶ˆæ¯ç±»å‹æ£€æµ‹ä¼˜åŒ–**:
- **æ•ˆæœ**: ç”¨æˆ·ä½“éªŒæå‡ï¼Œæ ¼å¼è‡ªåŠ¨è¯†åˆ«
- **å®ç°**: æ­£åˆ™è¡¨è¾¾å¼å¿«é€Ÿæ£€æµ‹
- **é€‚ç”¨**: å¯Œæ–‡æœ¬æ¶ˆæ¯å¤„ç†

---

### 6.2 ç¨³å®šæ€§ä¼˜åŒ–
**WebSocketé‡è¿æœºåˆ¶**:
- **æ•ˆæœ**: ä»"ç»å¸¸æ–­å¼€"åˆ°"è¿æ¥éå¸¸ç¨³å®š"
- **å®ç°**: è‡ªåŠ¨é‡è¿5æ¬¡ + å¿ƒè·³ä¿æ´»
- **é€‚ç”¨**: æ‰€æœ‰é•¿è¿æ¥æœåŠ¡

**é”™è¯¯é‡è¯•æœºåˆ¶**:
- **æ•ˆæœ**: ç½‘ç»œæ³¢åŠ¨ä¸å½±å“æœåŠ¡
- **å®ç°**: æŒ‡æ•°é€€é¿ + æœ€å¤š3æ¬¡é‡è¯•
- **é€‚ç”¨**: æ‰€æœ‰å¤–éƒ¨APIè°ƒç”¨

---

### 6.3 å¯ç»´æŠ¤æ€§ä¼˜åŒ–
**è¯Šæ–­è„šæœ¬**:
- **æ•ˆæœ**: é—®é¢˜å®šä½æ—¶é—´ä»5åˆ†é’Ÿç¼©çŸ­åˆ°1åˆ†é’Ÿ
- **å®ç°**: ä¸€é”®æ£€æŸ¥è¿›ç¨‹ã€ç«¯å£ã€æ—¥å¿—
- **é€‚ç”¨**: æ—¥å¸¸è¿ç»´

**ç»Ÿä¸€ç®¡ç†è„šæœ¬**:
- **æ•ˆæœ**: æœåŠ¡ç®¡ç†æ ‡å‡†åŒ–
- **å®ç°**: start.sh/stop.sh/status.sh
- **é€‚ç”¨**: æ‰€æœ‰åå°æœåŠ¡

---

### ä¸ƒã€å…³é”®é…ç½®æ–‡ä»¶


### 7.1 é’‰é’‰æœºå™¨äººé…ç½®
**è·¯å¾„**: `/home/admin/.opencode/skills/dingtalk-robot/config.json`

```json
{
  "CLIENT_ID": "your_dingtalk_app_key_here",
  "CLIENT_SECRET": "your_dingtalk_app_secret_here",
  "AUTHORIZED_USERS": [
    "your_user_id-772156749",
    "$:LWCP_v1:$S9zNS4CpGKJuieRRfC0k40xVfkK9wl/w"
  ],
  "QUEUE_DIR": "/home/admin/.opencode/skills/dingtalk-robot/queue"
}
```

---

### 7.2 OpenCodeé…ç½®
**è·¯å¾„**: `/home/admin/.config/opencode/oh-my-opencode.json`

**æ¨¡å‹åˆ†é…ç­–ç•¥**:
- ä¸»æ™ºèƒ½ä½“ï¼ˆsisyphusï¼‰: æ™ºè°±maxï¼ˆglm-5ï¼‰
- é¡¾é—®ï¼ˆoracleï¼‰: æ™ºè°±maxï¼ˆglm-5ï¼‰
- ä»£ç æ¢ç´¢ï¼ˆexploreï¼‰: ç™¾ç‚¼è½»é‡ï¼ˆqwen3-coder-plusï¼‰
- è§†è§‰ï¼ˆmultimodal-lookerï¼‰: æ™ºè°±4.6v
- ä»£ç å®¡æŸ¥ï¼ˆmomusï¼‰: Claude 3.5 Sonnetï¼ˆå¶å°”ä½¿ç”¨ï¼‰

---

### å…«ã€ç»´æŠ¤æ£€æŸ¥æ¸…å•


### æ¯æ—¥æ£€æŸ¥
- [ ] æ£€æŸ¥OpenCodeè¿›ç¨‹çŠ¶æ€
- [ ] æŸ¥çœ‹é’‰é’‰æœºå™¨äººæ—¥å¿—é”™è¯¯
- [ ] ç¡®è®¤Tokenç¼“å­˜æ­£å¸¸åˆ·æ–°
- [ ] éªŒè¯WebSocketè¿æ¥ç¨³å®š

### æ¯å‘¨æ£€æŸ¥
- [ ] æ¸…ç†è¿‡æœŸæ—¥å¿—æ–‡ä»¶
- [ ] æ£€æŸ¥ç£ç›˜ç©ºé—´ä½¿ç”¨
- [ ] å®¡æŸ¥APIè°ƒç”¨é…é¢
- [ ] æ›´æ–°ä¾èµ–åŒ…ç‰ˆæœ¬

### æ¯æœˆæ£€æŸ¥
- [ ] å®¡æŸ¥å®‰å…¨é…ç½®
- [ ] è¯„ä¼°æ€§èƒ½ç“¶é¢ˆ
- [ ] å¤‡ä»½å…³é”®é…ç½®
- [ ] æ€»ç»“ç»´æŠ¤ç»éªŒ

---

### ä¹ã€ç»éªŒæ€»ç»“


### 9.1 æ ¸å¿ƒåŸåˆ™
1. **å¤±è´¥å¿«é€Ÿåˆ‡æ¢**: åŒä¸€æ–¹æ³•å¤±è´¥3æ¬¡ç«‹å³æ¢æ–¹æ³•
2. **ç‹¬ç«‹éªŒè¯**: å¤æ‚é›†æˆå‰å…ˆåœ¨ç‹¬ç«‹ç¯å¢ƒéªŒè¯
3. **ä¸»åŠ¨ç›‘æ§**: ä¸ä¾èµ–ç”¨æˆ·åé¦ˆï¼Œä¸»åŠ¨ç›‘æ§æœåŠ¡å¥åº·
4. **ä¿æŒå¤‡ä»½**: ä»»ä½•ä¿®æ”¹å‰ä¿ç•™å·¥ä½œå¤‡ä»½

### 9.2 æŠ€æœ¯è¦ç‚¹
- **ç¼“å­˜ç­–ç•¥**: Tokenç¼“å­˜å¯æ˜¾è‘—å‡å°‘APIè°ƒç”¨
- **é‡è¯•æœºåˆ¶**: æŒ‡æ•°é€€é¿é¿å…æœåŠ¡å™¨å‹åŠ›
- **å¿ƒè·³ç›‘æ§**: åŠæ—¶å‘ç°è¿æ¥å¼‚å¸¸
- **æ™ºèƒ½æ£€æµ‹**: è‡ªåŠ¨è¯†åˆ«æ¶ˆæ¯ç±»å‹æå‡ä½“éªŒ

### 9.3 å·¥å…·ä½¿ç”¨
- **explore agent**: å¿«é€Ÿåˆ†æä»£ç ç»“æ„
- **diagnose.sh**: ä¸€é”®è¯Šæ–­ç³»ç»ŸçŠ¶æ€
- **LSPå·¥å…·**: è¾…åŠ©å‘ç°ä»£ç é—®é¢˜
- **æ—¥å¿—åˆ†æ**: å¿«é€Ÿå®šä½é—®é¢˜æ ¹å› 

---

### åã€åç»­æ”¹è¿›å»ºè®®


### 10.1 çŸ­æœŸæ”¹è¿›
1. **å®Œå–„OpenCodeæ™ºèƒ½ä½“é›†æˆ**: æ·±å…¥ç†è§£æ™ºèƒ½ä½“è°ƒç”¨æœºåˆ¶
2. **å¢å¼ºç›‘æ§å‘Šè­¦**: æ·»åŠ é‚®ä»¶/é’‰é’‰å‘Šè­¦
3. **ä¼˜åŒ–æ—¥å¿—æ ¼å¼**: ç»Ÿä¸€æ—¥å¿—æ ¼å¼ï¼Œä¾¿äºåˆ†æ

### 10.2 ä¸­æœŸæ”¹è¿›
1. **è‡ªåŠ¨åŒ–éƒ¨ç½²**: ä¸€é”®éƒ¨ç½²è„šæœ¬
2. **æ€§èƒ½æŒ‡æ ‡æ”¶é›†**: Prometheus/Grafanaç›‘æ§
3. **é…ç½®ç‰ˆæœ¬ç®¡ç†**: Gitç®¡ç†é…ç½®å˜æ›´

### 10.3 é•¿æœŸæ”¹è¿›
1. **æ™ºèƒ½æ•…éšœè¯Šæ–­**: AIè¾…åŠ©é—®é¢˜å®šä½
2. **è‡ªé€‚åº”è°ƒä¼˜**: æ ¹æ®ä½¿ç”¨æƒ…å†µè‡ªåŠ¨ä¼˜åŒ–é…ç½®
3. **å¤šç¯å¢ƒæ”¯æŒ**: å¼€å‘/æµ‹è¯•/ç”Ÿäº§ç¯å¢ƒéš”ç¦»

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2026-02-15
**ç»´æŠ¤äºº**: OpenCodeç³»ç»Ÿç»´æŠ¤å›¢é˜Ÿ