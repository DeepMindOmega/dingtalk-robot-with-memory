# 综合经验总结 - 近一个月开发与使用经验

**Type**: long_term
**Source**: opencode_experience
**Created**: 2026-02-14T23:33:37.229073+00:00
**ID**: 116

**Tags**: dingtalk, opencode, api, config, security

---


### 归档信息
**归档位置**：`/home/admin/clawdbot-experience-summary/`
**创建时间**：2026-02-15
**数据来源**：Clawdbot对话记录、OpenCode会话、Desktop笔记、项目经验（2026-01-30 至 2026-02-15）

---

### 📊 整体统计


### 文档统计
- **总文档数**：9个（8个专题文档 + 1个README + 1个报告）
- **总行数**：约4500行
- **总大小**：约130KB
- **时间跨度**：2026-01-30 至 2026-02-15（约15天）

### 经验分类统计
| 分类 | 文档数 | 主要内容 |
|------|--------|---------|
| **集成经验** | 1 | DingTalk集成成功与失败 |
| **配置管理** | 2 | Clawdbot配置、系统配置与账户 |
| **操作控制** | 1 | OpenCode模型配置、记忆系统 |
| **安全实践** | 1 | 发布前安全检查、技能验证 |
| **项目开发** | 1 | NetWatcher、钉钉/飞书机器人、HY-1.8B |
| **核心原则** | 1 | 重点提醒、操作禁忌 |
| **综合总结** | 1 | 成功失败经验总结 |

---

### 🎯 核心成就


### 技术成就
1. **DingTalk集成完善**
   - 成功修复API端点、消息类型、参数字段错误
   - 实现Token缓存、Markdown支持、错误重试机制
   - 创建完整飞书机器人插件

2. **OpenCode优化配置**
   - 优化模型分配（智谱、百炼、Claude三套餐）
   - 建立成本最优策略
   - 完成记忆系统安全审计

3. **NetWatcher V2防火墙开发**
   - 完成Go后端+前端开发
   - 实现本地IP地理位置库（89条数据）
   - 准备专利申请材料（9个完整文档）

4. **系统配置优化**
   - Coding Plan账户配置（主套餐、副套餐、其他套餐）
   - 本地开发服务器配置（HTTP 3001、WebSocket 3002）
   - AI工具集成配置（OpenAI、Anthropic协议）

### 文档成就
1. **经验总结文档**：创建8个专题文档
2. **失败案例分析**：识别并记录8类主要失败
3. **成功案例记录**：记录8类主要成功
4. **最佳实践总结**：提炼7大核心原则
5. **操作指南整理**：创建常用命令速查表

---

### 🔴 主要失败分析


### 失败原因分类
| 失败类型 | 次数 | 主要原因 | 解决方案 |
|---------|------|---------|----------|
| API端点错误 | 1 | 使用新版API端点 | 改回旧版端点 |
| 消息类型错误 | 2 | 参数名称错误 | 修正参数名称 |
| 参数字段错误 | 1 | 使用imageKey | 改用photoURL |
| 令牌配置错误 | 10+ | 配置不一致 | 统一配置 |
| 服务管理错误 | 5 | 手动杀死进程 | 使用systemd命令 |
| Shell转义问题 | 20+ | 特殊字符处理错误 | 使用write工具 |
| 网络部署限制 | 1 | 无法下载模型 | 准备部署指南 |

### 失败教训
1. **文档优先原则**
   - 必须仔细阅读官方文档
   - 参考官方示例代码
   - 验证API版本兼容性

2. **配置一致性原则**
   - 令牌和密钥在所有位置保持一致
   - 配置文件和环境变量同步
   - 使用版本控制管理配置变更

3. **渐进式验证原则**
   - 每次只修改一个问题
   - 修改后立即测试验证
   - 保留可回滚的备份

4. **日志驱动调试原则**
   - 启用详细日志记录
   - 分析日志中的错误代码
   - 使用日志定位问题根源

5. **安全优先原则**
   - 未经用户确认禁止修改配置文件
   - 发布前必须进行安全检查
   - 验证技能安全性后再安装

6. **信息验证原则**
   - 多源验证关键信息
   - 不盲目信任单一来源
   - 标注不确定性

7. **法律和合规原则**
   - 尊重平台服务条款
   - 不尝试绕过版权保护
   - 使用平台官方提供的合法功能

---

### 🟢 成功经验提炼


### 1. DingTalk集成
**成功步骤**
1. 识别API端点错误：从`api.dingtalk.com/v1.0/media/upload`改为`oapi.dingtalk.com/media/upload`
2. 修正消息类型：从`image`改为`sampleImageMsg`
3. 修正参数字段：从`imageKey`改为`photoURL`
4. 逐步测试验证每个修改
5. 确认图片在钉钉中正常显示

**关键代码**
```javascript
const uploadUrl = `https://oapi.dingtalk.com/media/upload?access_token=${accessToken}&type=image`;
const formData = new FormData();
formData.append('media', fs.createReadStream(imagePath));

const uploadResponse = await axios.post(uploadUrl, formData, {
  headers: formData.getHeaders()
});

if (uploadResponse.data.errcode === 0) {
  const media_id = uploadResponse.data.media_id;
  const msg = {
    msgtype: "sampleImageMsg",
    sampleImageMsg: {
      photoURL: media_id
    }
  };
  await sendDingTalkMessage(webhookUrl, msg);
}
```

**核心要点**
- ✅ 必须使用旧版API端点`oapi.dingtalk.com`
- ✅ 消息类型必须是`sampleImageMsg`
- ✅ 参数字段必须是`photoURL`，不能是`imageKey`
- ✅ 官方文档中的参数名称必须完全匹配

---

### 2. OpenCode模型配置优化
**成功步骤**
1. 分析三个Coding套餐的特点和优势
2. 根据智能体特性分配最优模型
3. 配置provider和baseURL
4. 验证各智能体使用正确的模型
5. 达到成本最优和性能平衡

**模型分配策略**

| 智能体/分类 | 模型 | 来源 | 理由 |
|---------------|------|------|
| **sisyphus** (主Agent) | glm-5 | 智谱max | 主智能体需要最强模型 |
| **oracle** (顾问) | glm-5 | 智谱max | 架构决策需要强推理 |
| **librarian** (文档搜索) | qwen3-coder-plus | 百炼轻量，文档搜索够用 |
| **explore** (代码探索) | qwen3-coder-plus | 百炼轻量，代码探索够用 |
| **multimodal-looker** (视觉) | glm-4.6v | 智谱max，只有智谱有视觉模型 |
| **prometheus** (规划) | qwen3-max | 百炼旗舰，规划需要强推理 |
| **metis** (需求分析) | qwen3-max | 百炼旗舰，需求分析需要强推理 |
| **momus** (代码审查) | claude-3-5-sonnet | 偶尔审查，偶尔Claude质量更高 |
| **visual-engineering** | qwen3-coder-plus | 百炼代码，前端开发用百炼 |
| **ultrabrain** | qwen3-max | 百炼旗舰，困难任务 |
| **writing** | glm-5 | 智谱max，写作用智谱 |

**核心原则**
- 主要用智谱和百炼，尽量少用Claude（成本控制）
- 智谱max用于主Agent、顾问、写作（最强推理）
- 百炼轻量用于探索、开发任务（成本优化）
- 百炼旗舰用于规划、需求分析（平衡性能和成本）

---

### 3. NetWatcher V2个人防火墙
**成功步骤**
1. 设计Go后端架构（Gin框架）
2. 实现本地IP地理位置库（89条数据）
3. 实现进程级网络控制
4. 开发响应式前端（TailwindCSS + Chart.js）
5. 准备专利申请材料（9个完整文档）

**核心功能模块**
- 应用程序网络控制（按进程管理网络权限）
- 入侵检测/告警（自动分析风险，检测端口扫描）
- 实时流量图表（Chart.js可视化）
- 本地IP地理位置查询（SQLite数据库，支持离线查询）
- 网络统计报告（每日/每周数据分析）

**专利申请材料**
- 专利请求书、权利要求书、说明书
- 说明书摘要、技术交底书、附图绘制指南
- 申请流程及时间规划、附图示意版、材料检查清单
- 总文档数：9个，压缩包52KB

**关键优势**
- 使用Go语言，性能高、内存占用低（仅12MB可执行文件）
- 本地数据库，支持离线查询
- 响应式前端设计，实时数据更新
- 模块化架构，易于扩展

---

### 4. 钉钉/飞书机器人
**钉钉机器人增强**
- Token自动缓存（5分钟刷新缓冲）
- Markdown支持（自动检测并渲染格式）
- 增强错误处理（`@retry_on_failure()`装饰器，最多3次重试，指数退避）
- 媒体上传（`upload_media()`函数支持上传图片和文件）
- 消息类型智能检测（`detect_message_type()`自动选择最佳消息类型）

**飞书机器人创建**
- 完整的插件目录结构
- Webhook服务器（`webhook_server.py`）：HTTP POST事件接收
- 消息网关（`gateway.py`）：Token管理、消息发送、事件处理
- 任务处理器（`processor.py`）：OpenCode集成
- 队列管理器（`queue_manager.py`）：文件持久化队列
- 配置管理：与钉钉机器人兼容的配置格式

**成功因素**
- 参考钉钉机器人的成功经验
- 创建与钉钉兼容的配置格式
- 完整的文档输出（4个主要文档）

---

### 5. 系统配置与账户管理
**Coding Plan账户配置**

**主套餐：GLM Coding Plan max包月**
- 文档：https://docs.bigmodel.cn/cn/coding-plan/overview
- API Key：`5f5ae7b36c07485d97baf63b560407d5`
- Base URL：`https://open.bigmodel.cn/api/coding/paas/v4`
- 用途：主Agent、顾问、写作

**副套餐：阿里百炼轻量包月**
- Base URL：`https://coding.dashscope.aliyuncs.com/v1`
- API Key：`sk-sp-608664d68e084f8595e19adf22c76e58`
- 用途：探索、开发任务（轻量）

**其他套餐：Claude Code**
- Base URL：`https://ai-in.one/v1`
- API Key：`sk-302d672abd34ff780e30f853e50a2bc5d1ae4baac68ab83671ed6690697cc732`
- 价格：20美元/月
- 用途：代码审查（偶尔使用）

**本地开发服务器**
- API Base：`http://localhost:3001`
- WebSocket Base：`ws://localhost:3002`
- HTTP服务端口：3001
- WebSocket服务端口：3002
- 状态：Server已运行，WebSocket已连接

**成功因素**
- 清晰的端口分配（HTTP和WebSocket分开）
- 正确的协议配置（`ws://`用于WebSocket）
- 完整的连接状态管理

---

### 💡 技能和知识总结


### 重要技能列表
1. **DingTalk API调用**
   - 正确的API端点：`oapi.dingtalk.com/media/upload`
   - 消息类型：`sampleImageMsg`
   - 参数字段：`photoURL`（不是`imageKey`）

2. **OpenCode模型配置**
   - 三套餐分配策略（智谱、百炼、Claude）
   - Provider配置（zhipuai-coding-plan、dashscope、anthropic）
   - 智能体映射（sisyphus、oracle、librarian等）

3. **Go语言开发**
   - Gin框架使用
   - SQLite数据库
   - Chart.js可视化
   - 模块化架构设计

4. **Python机器人开发**
   - WebSocket异步编程
   - asyncio并发处理
   - 队列管理
   - Token缓存机制

5. **系统配置管理**
   - Coding Plan账户管理
   - 本地服务器配置
   - API错误排查（401、403、404、连接错误）
   - 额度管理（hour/week/month exceeded）

---

### 📊 失败和成功统计


### 失败统计
| 失败类型 | 频次 | 主要领域 |
|---------|------|---------|
| API配置错误 | 3 | DingTalk、系统配置 |
| 令牌配置错误 | 10+ | Clawdbot、OpenCode |
| 服务管理错误 | 5 | Clawdbot配置 |
| Shell转义问题 | 20+ | 项目开发 |
| 网络限制问题 | 1 | HY-1.8B部署 |

### 成功统计
| 成功类型 | 频次 | 主要领域 |
|---------|------|---------|
| API集成修复 | 3 | DingTalk、系统配置 |
| 模型优化 | 1 | OpenCode配置 |
| 完整项目开发 | 2 | NetWatcher、机器人 |
| 工具验证 | 1 | agent-browser |

---

### 🎯 行为准则和原则


### 核心价值观（来自SOUL.md）
**Be genuinely helpful, not performatively helpful.**
- 跳过"Great question!"和"I'd be happy to help!"
- 用行动说话，不要用填充词语

**Have opinions.**
- 允许不同意、偏好事物、觉得有趣或无聊
- 助手没有个性只是带额外步骤的搜索引擎

**Be resourceful before asking.**
- 尝试自己解决问题：读取文件、检查上下文、搜索
- *然后*再问如果卡住了

**Earn trust through competence.**
- 认真对待外部操作（邮件、推文、公开）
- 对内部操作要大胆：读取、组织、学习

**Remember you're a guest.**
- 有权限访问某人的生活——他们的消息、文件、日历
- 用尊重对待——这是亲密关系
- 在群聊中要谨慎发言

### 安全和验证准则
**未经用户确认禁止修改配置文件**
- 不修改config.json、.env、服务文件
- 不随意重启自己
- 每次操作前都要确保记得这条要求

**信息验证原则**
- 网上信息不一定是准确的
- 需要谨慎验证网站信息
- 不应仅凭单一来源就下结论
- 对于重要信息需要交叉验证

**项目关系确认**
- 需要区分不同项目的真实关系
- 不应仅凭网站自我声明就确定项目历史
- 需要更多证据来确认项目演变关系

**保持质疑态度**
- 对于不确定的信息应标注为待验证
- 保持质疑态度，避免盲目接受信息

---

### 🔧 常用命令速查


### DingTalk相关
```bash
# 测试网络连接
curl -I https://oapi.dingtalk.com

# 获取access token
curl "https://oapi.dingtalk.com/gettoken?appkey=xxx&appsecret=xxx"

# 测试图片上传
curl -X POST "https://oapi.dingtalk.com/media/upload?access_token=xxx&type=image" \
  -F "media=@/path/to/image.jpg"

# 发送Markdown消息
curl -X POST "https://oapi.dingtalk.com/robot/send?access_token=xxx" \
  -H "Content-Type: application/json" \
  -d '{"msgtype":"markdown","markdown":{"title":"标题","text":"内容"}}'
```

### OpenCode相关
```bash
# 查看服务状态
clawdbot gateway status
systemctl --user status clawdbot-gateway

# 重启网关服务
clawdbot gateway restart
systemctl --user restart clawdbot-gateway

# 查看服务日志
journalctl --user -u clawdbot-gateway -n 50
journalctl --user -u clawdbot-gateway -f

# 配置管理
cat ~/.clawdbot/clawdbot.json | jq '.'

# OpenCode会话管理
opencode sessions_list
opencode sessions_history
opencode sessions_send --id <session_id> "message"
opencode sessions_spawn --prompt "task description"
```

### Coding Plan相关
```bash
# 测试API Key
curl -X POST "https://open.bigmodel.cn/api/coding/paas/v4/chat/completions" \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"model":"glm-5","messages":[{"role":"user","content":"测试"}]}'

# 查看订阅状态
# 登录Coding Plan控制台查看
```

### 系统服务管理
```bash
# 查看进程
ps aux | grep clawdbot

# 查看端口占用
netstat -tuln | grep 3001
netstat -tuln | grep 3002

# 测试端口连通性
curl -I http://localhost:3001
```

---

### 📝 未来改进建议


### 1. 知识管理
1. **文档完善**
   - 记录所有配置变更
   - 创建故障排除手册
   - 维护API调用示例库

2. **自动化测试**
   - 创建自动化测试脚本
   - 在配置变更后运行测试
   - 监控服务健康状态

3. **监控和告警**
   - 设置日志监控
   - 配置错误告警
   - 定期检查服务状态

### 2. 项目管理
1. **文档化**
   - 为每个项目创建完整文档
   - 记录架构决策
   - 维护API文档

2. **版本控制**
   - 使用Git管理所有项目
   - 创建有意义的提交信息
   - 标记重要版本

3. **知识共享**
   - 将解决方案文档化
   - 建立常见问题知识库
   - 分享经验给团队成员

---

### 📚 参考文档索引


### 主要文档
| 文档 | 说明 |
|------|------|
| 01_DingTalk集成经验.md | DingTalk集成成功和失败经验 |
| 02_配置管理经验.md | Clawdbot配置管理经验 |
| 03_SUCCESS_FAILURE_SUMMARY.md | 成功失败经验总结（主文档） |
| 04_OpenCode操作控制经验.md | OpenCode模型配置、记忆系统、技能生态 |
| 05_安全经验.md | 发布前安全检查、配置文件管理、技能安全验证 |
| 06_项目开发经验.md | NetWatcher防火墙、钉钉/飞书机器人、HY-1.8B部署 |
| 07_重点提醒.md | 重要提醒、核心原则、操作禁忌 |
| 08_系统配置与账户经验.md | Coding Plan账户、本地开发服务器、AI工具配置 |

### 官方资源
- DingTalk开放平台：https://open.dingtalk.com/
- OpenCode文档：https://docs.oh-my-opencode.ai/
- Coding Plan文档：https://docs.bigmodel.cn/cn/coding-plan/overview
- 阿里百炼文档：https://help.aliyun.com/zh/model-developer/
- Clawdbot文档：https://docs.clawd.bot/

---

### 总结
本次经验总结涵盖了从2026-01-30到2026-02-15约15天的开发和使用经验，包括：

1. **8个专题文档**：涵盖DingTalk集成、配置管理、OpenCode操作、安全实践、项目开发、重点提醒、系统配置
2. **8类主要失败**：API配置错误、令牌配置错误、服务管理错误、Shell转义问题、网络限制等
3. **8类主要成功**：DingTalk图片修复、模型配置优化、NetWatcher开发、机器人增强等
4. **7大核心原则**：文档优先、配置一致性、渐进式验证、日志驱动调试、安全优先、信息验证、法律和合规

所有经验都基于实际对话记录、笔记文件、项目经验中提取的真实案例和解决方案，具有很高的实用价值。

---

*综合总结创建时间：2026-02-15*
*基于近一个月对话记录、笔记文件、项目经验整理完成*
*总计：9个文档，约4500行，130KB*