# 安全经验

**Type**: long_term
**Source**: opencode_experience
**Created**: 2026-02-14T23:33:39.898023+00:00
**ID**: 129

**Tags**: opencode, api, config, security

---

## 概述
文档时间范围：2026-01-30 至 2026-02-15
主题：软件发布安全、配置文件管理、技能安全验证

### 🔴 安全风险和教训


### 风险1：发布软件包前未检查敏感信息
**问题描述**
- 在打包发布前未检查是否包含敏感信息
- 可能泄露API密钥、密码、令牌等敏感数据
- 配置文件、环境变量、代码注释中可能包含敏感信息

**风险等级**
- **高危**：可能导致严重的安全泄露

**解决方案**

**发布前安全检查清单**
```bash
# 1. 搜索敏感字符串
grep -r -i "api.*key\|secret\|token\|password\|credential" . --exclude-dir=node_modules --exclude-dir=.git

# 2. 检查配置文件
ls -la | grep -E "\.(env|config|json)$"

# 3. 检查环境变量文件
cat .env | grep -iE "key|secret|token|password"

# 4. 检查代码注释
grep -r "TODO.*remove.*before.*release\|FIXME.*security" .
```

**发布前必须检查的内容**
- ✅ 配置文件是否包含敏感信息
- ✅ 环境变量文件是否包含敏感信息
- ✅ 代码注释是否包含敏感信息
- ✅ 测试文件是否包含测试凭据
- ✅ 示例配置文件是否使用占位符

**发布包应只包含**
- ✅ 必需的源代码
- ✅ 公开文档
- ✅ README和LICENSE文件
- ✅ 构建脚本

**发布包不应包含**
- ❌ 配置文件中的真实API密钥
- ❌ 环境变量文件（.env）
- ❌ 测试文件中的测试凭据
- ❌ 个人信息或内部文档

**核心原则**
1. 每次发布软件包前都必须进行安全扫描
2. 建立标准的发布前安全检查清单
3. 在所有项目中使用外部配置管理敏感信息
4. 不硬编码任何敏感信息到代码中

---

### 风险2：配置文件修改未备份
**问题描述**
- 更改任何配置文件前未备份原始文件
- 配置文件损坏后无法恢复
- 配置错误导致系统无法启动

**风险等级**
- **中危**：可能导致系统不可用

**解决方案**

**配置文件管理最佳实践**
```bash
# 1. 修改前备份
cp config.json config.json.bak.$(date +%Y%m%d_%H%M%S)

# 2. 或者使用git版本控制
git add config.json
git commit -m "Backup config before changes"

# 3. 修改配置
vi config.json

# 4. 验证配置格式
jq '.' config.json

# 5. 测试配置
systemctl --user restart service

# 6. 如果失败，快速恢复
cp config.json.bak.* config.json
systemctl --user restart service
```

**备份策略**
1. **时间戳备份**：`config.json.bak.20260215_103000`
2. **版本控制**：使用git管理配置文件
3. **保留多个版本**：不要覆盖，而是创建新备份
4. **备份位置**：将备份存储在独立目录

**关键要点**
- ✅ 更改任何配置文件前，一定要备份一份原始文件
- ✅ 使用时间戳或版本号标识备份
- ✅ 保留多个版本的备份以防需要回滚
- ✅ 验证备份文件的完整性

---

### 风险3：技能安装未验证安全性
**问题描述**
- 随意安装技能，未验证安全性
- 技能可能包含恶意代码
- 可能泄露数据或破坏系统

**风险等级**
- **高危**：可能导致数据泄露或系统破坏

**解决方案**

**技能安全验证清单**
```bash
# 1. 检查技能来源
# 查看GitHub仓库、作者、Star数量
# 查看最近更新时间

# 2. 检查技能内容
# 查看技能目录结构
# 检查是否包含可执行文件
# 检查依赖项

# 3. 审查代码（如果开放源代码）
git clone <skill_repo>
cd <skill_repo>
grep -rE "exec\|eval\|system\|subprocess" src/

# 4. 测试在隔离环境
# 创建测试目录
# 在测试环境中安装和测试技能
```

**安全的技能类型**
- ✅ 纯文档技能（.md文档）
- ✅ 工具指南技能（最佳实践说明）
- ✅ API参考文档技能

**谨慎的技能类型**
- ⚠️ 包含可执行脚本（.sh, .py, .js）
- ⚠️ 需要外部工具安装
- ⚠️ 包含二进制组件
- ⚠️ 包含外部依赖

**拒绝的技能类型**
- ❌ 来源不明的技能
- ❌ 没有文档的技能
- ❌ 最近未更新的技能
- ❌ 包含网络请求的技能（除非必要且透明）

**安全偏好**
- 偏好纯文档技能（无可执行代码）
- 强调在安装前验证技能安全性
- 重点关注维护系统完整性
- 强烈的安全优先思维

---

### 💡 重要技能和知识


### 发布前安全检查
**敏感信息搜索模式**
```bash
# API Keys
grep -r -i "api_key\|apikey\|api-key" .

# Secrets/Tokens
grep -r -i "secret\|token\|credential" .

# Passwords
grep -r -i "password\|passwd" .

# Database URLs
grep -r -i "mongodb://\|mysql://\|postgresql://" .
```

**配置文件检查**
```bash
# 检查.env文件
ls -la | grep ".env"
cat .env

# 检查config文件
ls -la | grep "config"
cat config.json | jq .

# 检查是否包含敏感信息
grep -rE "\"(api_key|secret|token|password)\":" config/
```

### 配置文件备份策略
**自动备份脚本**
```bash
#!/bin/bash
# backup_config.sh

CONFIG_FILE="config.json"
BACKUP_DIR="backups"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR
cp $CONFIG_FILE $BACKUP_DIR/$CONFIG_FILE.bak.$TIMESTAMP

echo "Backup created: $BACKUP_DIR/$CONFIG_FILE.bak.$TIMESTAMP"
```

**使用方法**
```bash
# 添加到.bashrc或.zshrc
alias backup-config='/path/to/backup_config.sh'

# 使用时运行
backup-config
```

### Git版本控制配置
```bash
# 初始化git仓库
git init

# 添加配置文件
git add config.json .env

# 创建初始提交
git commit -m "Initial config backup"

# 每次修改前
git add config.json
git commit -m "Backup before changes: $(date)"

# 查看历史
git log --oneline config.json

# 恢复特定版本
git checkout <commit_hash> config.json
```

---

### 📊 安全检查清单


### 发布前检查
| 检查项 | 通过 | 说明 |
|---------|------|------|
| 扫描API密钥 | ☐ | grep -r "api.*key" |
| 扫描密码 | ☐ | grep -r "password" |
| 扫描令牌 | ☐ | grep -r "token" |
| 扫描敏感字符串 | ☐ | grep -r "secret\|credential" |
| 检查配置文件 | ☐ | review .env, config files |
| 检查代码注释 | ☐ | grep -r "TODO.*remove" |
| 验证占位符 | ☐ | ensure placeholder values |
| 移除测试数据 | ☐ | remove test credentials |
| 移除环境变量 | ☐ | exclude .env files |
| 安全扫描 | ☐ | run security tools |

### 技能安装前检查
| 检查项 | 通过 | 说明 |
|---------|------|------|
| 检查来源信誉 | ☐ | GitHub stars, author |
| 检查最近更新 | ☐ | last commit date |
| 检查文档 | ☐ | README exists |
| 检查代码 | ☐ | review source code |
| 检查依赖 | ☐ | review dependencies |
| 测试环境 | ☐ | test in isolation |
| 检查权限 | ☐ | review permissions |

---

### 🎯 安全最佳实践


### 1. 发布前安全检查
1. **创建标准检查清单**
   - 每次发布前运行完整检查
   - 记录检查结果
   - 保留检查历史

2. **自动化安全扫描**
   - 使用工具自动扫描敏感信息
   - 配置CI/CD管道自动检查
   - 失败时阻止发布

3. **外部配置管理**
   - 所有敏感信息使用环境变量
   - 使用配置管理工具（Vault等）
   - 不在代码中硬编码敏感信息

### 2. 配置文件管理
1. **版本控制**
   - 使用git管理配置文件
   - 记录每次变更
   - 支持快速回滚

2. **备份策略**
   - 自动化备份流程
   - 保留多个历史版本
   - 存储在安全位置

3. **权限控制**
   - 限制配置文件访问权限
   - 仅允许必要用户访问
   - 定期审查权限

### 3. 技能安全管理
1. **验证优先**
   - 安装前验证技能来源
   - 审查技能代码
   - 测试在隔离环境

2. **文档偏好**
   - 优先选择纯文档技能
   - 避免可执行代码技能
   - 谨慎对待外部依赖

3. **最小权限原则**
   - 仅授予技能必要权限
   - 定期审查技能权限
   - 及时移除不需要的技能

---

### 🔧 常用工具和命令


### 安全扫描工具
```bash
# 搜索敏感信息
grep -r -i "api.*key\|secret\|token\|password\|credential" . --exclude-dir=node_modules

# 使用truffleHog（如果已安装）
trufflehog --regex --entropy=False ./

# 使用git-secrets（如果已安装）
git-secrets scan
```

### 备份工具
```bash
# 创建备份
cp file file.bak.$(date +%Y%m%d_%H%M%S)

# Git备份
git add file
git commit -m "Backup: $(date)"

# 查看备份
ls -lh *.bak.*
git log --oneline
```

### 配置验证
```bash
# 验证JSON格式
jq '.' config.json

# 验证YAML格式（如果使用yq）
yq eval '.' config.yaml

# 验证环境变量
envsubst < config.template.json
```

---

### 📝 安全事件记录


### 历史教训
| 日期 | 事件 | 影响 | 教训 |
|------|------|------|------|
| 2026-01-30 | 发布前未检查敏感信息 | 潜在泄露风险 | 建立发布前检查清单 |
| 2026-01-31 | 配置文件未备份 | 系统配置丢失 | 实施自动备份策略 |
| 2026-02-01 | 技能未验证就安装 | 系统完整性风险 | 安装前验证流程 |

### 改进措施
| 问题 | 已实施 | 待实施 |
|------|--------|--------|
| 发布前检查 | ☐ 自动化扫描脚本 | ☐ CI/CD集成 |
| 配置备份 | ☐ 自动备份脚本 | ☐ Git版本控制 |
| 技能验证 | ☐ 验证清单 | ☐ 自动化测试环境 |

---

### 📚 参考资源


### 安全工具
- truffleHog: https://github.com/dxa4481/truffleHog
- git-secrets: https://github.com/awslabs/git-secrets
- Snyk: https://snyk.io/

### 相关文档
- `/home/admin/clawdbot-experience-summary/04_OpenCode操作控制经验.md`
- `/home/admin/clawdbot-experience-summary/06_项目开发经验.md`

---

*文档创建时间：2026-02-15*
*基于提醒和知识记录整理完成*